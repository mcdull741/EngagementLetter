# 模板管理功能规划与页面设计

## 功能概述
模板管理是Engagement Letter管理系统的核心功能之一，用于创建、编辑、管理Engagement Letter的模板，为快速生成标准化文档提供基础。

## 功能定位
- **核心目标**：提供标准化的Engagement Letter模板库
- **用户价值**：减少重复工作，确保文档格式一致性，提高生成效率
- **使用场景**：管理员为问卷上传word模板，用户点击导出时，根据EngLetter回答选择模板，系统根据模板和回答生成最终的Engagement Letter文档。

## 功能模块设计

### 1. 模板生命周期管理
- **创建**：管理员选择问卷并为问卷上传word文档。可以为模板添加条件，当问题集的答案与条件一致时，才选择该模板导出。
- **编辑**：修改模板的word文档，也可以为模板添加、删除、修改条件。
- **删除**：管理员可以删除不再需要的模板。

### 3. 模板内容结构

#### 3.1 模板基本信息
- 模板名称
- 模板描述
- 问卷名称
- 创建人
- 创建时间
- 修改时间

## 页面布局设计

### 1. 模板列表页（TemplateManagement/Index）

#### 模板列表页（最终简化版）

##### 页面结构（Word文档模板专用 - 无状态筛选）
```
┌────────────────────────────────────────────────────────────────────────┐
│  Word模板管理 - 为问卷配置Word文档模板                                 │
│  ┌─────────┬─────────┐                                                │
│  │ 上传模板│ 管理模板│                                                │
│  └─────────┴─────────┘                                                │
├────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────┐  ┌─────────────────────────────────┐  │
│  │ 问卷筛选                    │  │ 搜索：🔍 [搜索模板...]          │  │
│  │                             │  │                                 │  │
│  │ [全部问卷 ▼]               │  │ 排序：创建时间 ↓               │  │
│  │                             │  │                                 │  │
│  │ 条件筛选：                  │  │ ┌───────────────────────────┐   │  │
│  │ [显示有条件模板 □]          │  │ │ Word模板卡片              │   │  │
│  └─────────────────────────────┘  │ │                           │   │  │
│                                    │ │ ┌─────────────────────┐   │   │  │
│                                    │ │ │ 📎 年度审计模板.docx  │   │   │  │
│                                    │ │ │                     │   │   │  │
│                                    │ │ │ 问卷：年度审计问卷  │   │   │  │
│                                    │ │ │ 条件：3个条件       │   │   │  │
│                                    │ │ │ 创建：张三 1天前    │   │   │  │
│                                    │ │ │ [编辑] [删除]       │   │   │  │
│                                    │ │ └─────────────────────┘   │   │  │
│                                    │ │                           │   │  │
│                                    │ │ ┌─────────────────────┐   │   │  │
│                                    │ │ │ 📎 税务咨询模板.docx │   │   │  │
│                                    │ │ │                     │   │   │  │
│                                    │ │ │ 问卷：税务咨询问卷  │   │   │  │
│                                    │ │ │ 条件：无条件        │   │   │  │
│                                    │ │ │ 创建：李四 3天前    │   │   │  │
│                                    │ │ │ [编辑] [删除]       │   │   │  │
│                                    │ │ └─────────────────────┘   │   │  │
│                                    │ └───────────────────────────┘   │  │
│                                    │ [分页控件]                        │  │
│                                    └─────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────────────┘
```

##### 模板卡片设计（简化版）
```
┌─────────────────────────────────────────────┐
│ 📎 年度审计服务模板.docx                   │
│ 问卷：年度财务报表审计问卷                 │
│                                             │
│ 条件：3个（企业规模=大型, 审计类型=年报...）│
│ 创建：张三 | 2024-01-15 14:30              │
│                                             │
│ [编辑] [删除]                              │
└─────────────────────────────────────────────┘
```

##### 条件详情弹窗
```
┌────────────────────────────────────────────────────────┐
│ 模板条件详情                                          │
│ ┌────────────────────────────────────────────────────┐ │
│ │ 模板：年度审计模板.docx                            │ │
│ │ 问卷：年度财务报表审计问卷                         │ │
│ │                                                    │ │
│ │ 启用条件：                                         │ │
│ │ • 企业规模 = "大型企业"                          │ │
│ │ • 审计类型 包含 "年报"                           │ │
│ │ • 年收入 > 1000万                                │ │
│ │                                                    │ │
│ │ 逻辑：条件1 AND 条件2 OR 条件3                    │ │
│ └────────────────────────────────────────────────────┘ │
│ [关闭]                                                │
└────────────────────────────────────────────────────────┘
```

### 2. 模板创建/编辑页（TemplateManagement/Create 或 Edit）

#### 页面结构
```
┌─────────────────────────────────────────────────────────┐
│  创建新模板  |  ← 返回模板列表                              │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐  │
│  │ 基本信息区                                          │  │
│  │ 模板名称：[_____________________]                   │  │
│  │ 模板描述：[_____________________]                   │  │
│  │ 业务类型：[下拉选择 ▼] 客户规模：[下拉选择 ▼]      │  │
│  └─────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐  │
│  │ 内容编辑区                                          │  │
│  │ ┌─────────────┬───────────────────────────────────┐ │  │
│  │ │ 段落导航    │ 富文本编辑器                      │ │  │
│  │ │             │                                   │ │  │
│  │ │ • 文档头部  │ ┌─────────────────────────────┐ │ │  │
│  │ │ • 客户信息  │ │ [富文本编辑区域]            │ │ │  │
│  │ │ • 服务内容  │ │                             │ │ │  │
│  │ │ • 费用条款  │ │                             │ │ │  │
│  │ │ • 时间条款  │ │                             │ │ │  │
│  │ │ • 责任条款  │ │                             │ │ │  │
│  │ │ • 其他条款  │ │                             │ │ │  │
│  │ │             │ └─────────────────────────────┘ │ │  │
│  │ └─────────────┴───────────────────────────────────┘ │  │
│  └─────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐  │
│  │ 操作区                                              │  │
│  │ [保存草稿] [预览效果] [发布模板] [取消]            │  │
│  └─────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 3. 模板预览页（TemplateManagement/Preview）

#### 页面结构
```
┌─────────────────────────────────────────────────────────┐
│  模板预览  |  ← 返回模板列表  |  [编辑] [复制] [返回]      │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐  │
│  │ 模板信息                                            │  │
│  │ 模板名称：年度审计服务模板                          │  │
│  │ 版本：v2.1 | 状态：已发布 | 创建人：张三            │  │
│  │ 适用业务：审计业务 | 客户规模：大型企业             │  │
│  └─────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐  │
│  │ 模板内容预览                                        │  │
│  │                                                     │  │
│  │ [完整文档内容预览，保持格式]                        │  │
│  │                                                     │  │
│  └─────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

## 数据库设计

### 模板表结构（Template）
```sql
CREATE TABLE Template (
    Id NVARCHAR(450) PRIMARY KEY,
    QuestionnaireId NVARCHAR(450), -- 关联的问卷ID
    Name NVARCHAR(255) NOT NULL,
    Description NVARCHAR(1000),
    TemplatePath TEXT, -- 模板文件路径
    CreatedBy NVARCHAR(255),
    CreatedDate DATETIME2 NOT NULL,
    UpdatedBy NVARCHAR(255),
    UpdatedDate DATETIME2
);
```
### 模板条件表结构（TemplateCondition）
```sql
CREATE TABLE TemplateCondition (
    Id NVARCHAR(450) PRIMARY KEY,
    QuestionnaireId NVARCHAR(450), -- 关联的问卷ID
    QuestionId NVARCHAR(450), -- 关联的问题ID
    TemplateId NVARCHAR(450), -- 关联的模板ID
    TextResponse NVARCHAR(MAX)
);
```

## API接口设计

### 模板管理API
```
GET    /api/template                 # 获取模板列表（支持筛选、分页）
GET    /api/template/{id}            # 获取单个模板详情
POST   /api/template                 # 创建新模板
PUT    /api/template/{id}            # 更新模板
DELETE /api/template/{id}            # 删除模板
```

## 技术实现要点

### 1. 富文本编辑器
- 使用Quill.js或TinyMCE实现内容编辑
- 支持模板变量插入（如{{ClientName}}, {{ServiceDate}}等）
- 支持格式化文本、表格、列表等


## 后续扩展

### 1. 模板导入/导出
- 支持Word文档导入为模板
- 支持模板导出为标准格式
- 模板库备份与恢复

### 2. 智能推荐
- 基于历史使用数据推荐模板
- 基于客户特征推荐适用模板

### 3. 协作功能
- 模板共享给团队成员
- 模板评论和评分系统
- 模板使用统计分析

#### 模板优先级系统

##### 功能说明
每个模板设置优先级（整数），当EngLetter同时满足多个模板条件时，系统优先选用优先级最高的模板。优先级数值越大，优先级越高。

##### 优先级规则
- **数值范围**：1-100（1最低，100最高）
- **默认值**：50（中等优先级）
- **冲突处理**：同优先级时按创建时间降序选择
- **特殊值**：0表示禁用该模板（不参与匹配）

##### 优先级在界面中的体现

###### 模板列表页（带优先级显示）
```
┌─────────────────────────────────────────────┐
│ 📎 年度审计服务模板.docx  🔥 优先级: 85    │
│ 问卷：年度财务报表审计问卷                 │
│                                             │
│ 条件：3个（企业规模=大型, 审计类型=年报...）│
│ 创建：张三 | 2024-01-15 14:30              │
│                                             │
│ [编辑] [删除] [调整优先级]                 │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 📎 税务咨询模板.docx  🔥 优先级: 75        │
│ 问卷：税务咨询问卷                         │
│                                             │
│ 条件：无条件                                │
│ 创建：李四 | 2024-01-15 11:20              │
│                                             │
│ [编辑] [删除] [调整优先级]                 │
└─────────────────────────────────────────────┘
```

###### 优先级设置弹窗
```
┌─────────────────────────────────────┐
│ 模板优先级设置                          │
│ ┌─────────────────────────────────────┐ │
│ │ 模板：年度审计模板.docx             │ │
│ │                                     │ │
│ │ 当前优先级：85                      │ │
│ │                                     │ │
│ │ 优先级滑块：                        │ │
│ │ [1───25───50───75───100]           │ │
│ │     低      中      高     最高    │ │
│ │                                     │ │
│ │ 优先级说明：                        │ │
│ │ • 100：最高优先级 - 特殊定制模板    │ │
│ │ • 75-99：高优先级 - 常用标准模板    │ │
│ │ • 50-74：中优先级 - 一般模板        │ │
│ │ • 25-49：低优先级 - 备选模板        │ │
│ │ • 1-24：最低优先级 - 测试模板       │ │
│ └─────────────────────────────────────┘ │
│ [确认] [取消]                         │
└─────────────────────────────────────┘
```

###### 批量优先级管理
```
┌─────────────────────────────────────────┐
│ 批量调整模板优先级                      │
│ ┌─────────────────────────────────────┐ │
│ │ 选择问卷：年度审计问卷 ▼           │ │
│ │                                     │ │
│ │ 当前模板优先级：                    │ │
│ │ 📎 大型企业审计模板.docx  → 90    │ │
│ │ 📎 中型企业审计模板.docx  → 70    │ │
│ │ 📎 小型企业审计模板.docx  → 50    │ │
│ │ 📎 通用审计模板.docx      → 30    │ │
│ │                                     │ │
│ │ [一键升序排列] [一键降序排列]       │ │
│ └─────────────────────────────────────┘ │
│ [保存排序] [取消]                     │
└─────────────────────────────────────────┘
```

##### 模板匹配算法（伪代码）
```csharp
public class TemplateMatcher
{
    public Template SelectBestTemplate(List<Template> templates, QuestionnaireResponse response)
    {
        var matchingTemplates = templates
            .Where(t => IsConditionMet(t.Conditions, response))
            .OrderByDescending(t => t.Priority)  // 按优先级降序
            .ThenByDescending(t => t.CreatedDate) // 同优先级按创建时间
            .ToList();
            
        return matchingTemplates.FirstOrDefault();
    }
    
    private bool IsConditionMet(List<Condition> conditions, QuestionnaireResponse response)
    {
        // 条件匹配逻辑
        return true; // 简化示例
    }
}
```

##### 数据库更新
```sql
-- 在Templates表中添加Priority字段
ALTER TABLE Templates ADD Priority INT DEFAULT 50;

-- 创建优先级索引以优化查询
CREATE INDEX IX_Templates_Priority ON Templates(Priority DESC);

-- 更新现有模板优先级
UPDATE Templates SET Priority = 50 WHERE Priority IS NULL;
```

##### API接口更新
```
PUT /api/templates/{id}/priority    # 更新模板优先级
GET /api/templates/by-priority      # 按优先级获取模板列表
```

##### 前端优先级组件
```javascript
// 优先级显示组件
function PriorityBadge({ priority }) {
    const getColor = (p) => {
        if (p >= 90) return 'text-red-600';
        if (p >= 70) return 'text-orange-600';
        if (p >= 50) return 'text-yellow-600';
        if (p >= 30) return 'text-blue-600';
        return 'text-gray-600';
    };
    
    return <span className={`font-bold ${getColor(priority)}`}>🔥 {priority}</span>;
}

// 优先级滑块组件
function PrioritySlider({ value, onChange }) {
    return (
        <input
            type="range"
            min="1"
            max="100"
            value={value}
            onChange={(e) => onChange(parseInt(e.target.value))}
            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
        />
    );
}
```