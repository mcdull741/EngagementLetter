@model EngagementLetter.Models.Question
@using EngagementLetter.Models

<div class="question-form">
    <h5>编辑问题</h5>
    <hr />
    <form asp-action="Edit" method="post">
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="QuestionnaireId" />
        <input type="hidden" asp-for="SortOrder" />

        <div class="form-group mb-3">
            <label asp-for="Content" class="form-label required">问题内容</label>
            <textarea asp-for="Content" class="form-control" rows="3" required></textarea>
            <span asp-validation-for="Content" class="text-danger"></span>
        </div>

        <div class="form-group mb-3">
            <label asp-for="Type" class="form-label required">问题类型</label>
            <select asp-for="Type" class="form-select" required>
                <option value="Text">文本框</option>
                <option value="Radio">单选题</option>
                <option value="CheckBox">多选题</option>
            </select>
            <span asp-validation-for="Type" class="text-danger"></span>
        </div>

        <div id="optionsContainer" class="mb-3" style="display: @(Model.Type == QuestionType.Radio || Model.Type == QuestionType.CheckBox ? "block" : "none");">
            <label class="form-label required">选项</label>
            <div class="mb-2">
                <button type="button" id="addOption" class="btn btn-sm btn-outline-secondary">添加选项</button>
            </div>
            <div id="optionsList">
                @if (!string.IsNullOrEmpty(Model.OptionsJson))
                {
                    var options = Newtonsoft.Json.JsonConvert.DeserializeObject<List<string>>(Model.OptionsJson);
                    for (int i = 0; i < options.Count; i++)
                    {
                        <div class="option-item d-flex gap-2 mb-2">
                            <input type="text" class="form-control option-input" value="@options[i]" required />
                            <button type="button" class="btn btn-sm btn-danger remove-option">删除</button>
                        </div>
                    }
                }
            </div>
        </div>

        <div class="text-end">
            <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">取消</button>
            <button type="submit" class="btn btn-primary">保存</button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // 问题类型变更时显示/隐藏选项容器
            $('#Type').change(function () {
                const type = $(this).val();
                if (type === 'Radio' || type === 'CheckBox') {
                    $('#optionsContainer').show();
                    // 确保至少有一个选项
                    if ($('#optionsList .option-item').length === 0) {
                        addOption();
                    }
                } else {
                    $('#optionsContainer').hide();
                }
            });

            // 添加选项按钮点击事件
            $('#addOption').click(addOption);

            // 删除选项按钮委托事件
            $(document).on('click', '.remove-option', function () {
                $(this).closest('.option-item').remove();
            });

            // 表单提交前处理选项
            $('form').submit(function (e) {
                const type = $('#Type').val();
                if (type === 'Radio' || type === 'CheckBox') {
                    const options = [];
                    $('.option-input').each(function () {
                        const value = $(this).val().trim();
                        if (value) {
                            options.push(value);
                        }
                    });

                    if (options.length === 0) {
                        alert('请至少添加一个选项');
                        e.preventDefault();
                        return;
                    }

                    // 设置选项JSON
                    $('#OptionsJson').val(JSON.stringify(options));
                } else {
                    // 非选择题清空选项
                    $('#OptionsJson').val('');
                }
            });

            // 添加选项函数
            function addOption() {
                const optionHtml = `
                    <div class="option-item d-flex gap-2 mb-2">
                        <input type="text" class="form-control option-input" placeholder="输入选项内容" required />
                        <button type="button" class="btn btn-sm btn-danger remove-option">删除</button>
                    </div>
                `;
                $('#optionsList').append(optionHtml);
            }
        });
    </script>
}