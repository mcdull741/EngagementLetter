@model EngagementLetter.Models.EngLetter

@{ ViewData["Title"] = ViewBag.IsEditMode == true ? "编辑 Engagement Letter" : "预览 Engagement Letter"; }

<div class="container mx-auto px-4 py-8">
    <!-- 返回按钮 -->
    <div class="fixed top-4 right-4 z-10">
        <button onclick="window.history.back()" class="btn btn-primary">
            <i class="fas fa-arrow-left mr-2"></i>返回列表
        </button>
    </div>

    <!-- 页面标题 -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800">@ViewData["Title"]</h1>
    </div>
    
    <!-- 防伪令牌 -->
    @Html.AntiForgeryToken()

    <!-- Engagement Letter 基本信息卡片 -->
    <div class="bg-white rounded-lg shadow-md mb-8">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-800">
                <i class="fas fa-file-alt mr-2 text-blue-600"></i>基本信息
            </h2>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">标题</label>
                        @if (ViewBag.IsEditMode == true)
                        {
                            <input type="text" id="engLetterTitle" class="form-control text-lg font-semibold text-gray-900" value="@Model.Title" />
                        }
                        else
                        {
                            <p class="text-lg font-semibold text-gray-900">@Model.Title</p>
                        }
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">关联问卷</label>
                        <p class="text-gray-600">
                            <i class="fas fa-clipboard-list mr-1"></i>
                            @(Model.Questionnaire?.Title ?? "未设置")
                        </p>
                    </div>
                </div>
                <div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">创建日期</label>
                        <p class="text-gray-600">
                            <i class="fas fa-calendar-alt mr-1"></i>
                            @Model.CreatedDate.ToString("yyyy-MM-dd HH:mm")
                        </p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">最后修改</label>
                        <p class="text-gray-600">
                            <i class="fas fa-edit mr-1"></i>
                            @(Model.UpdatedDate?.ToString("yyyy-MM-dd HH:mm") ?? "未修改")
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 详细内容 -->
    <div class="bg-white rounded-lg shadow-md">
        <div class="p-6">
            <iframe id="engLetterContentFrame" 
                    src="/EngLetters/RenderContent?id=@Model.Id&mode=@(ViewBag.IsEditMode == true ? "edit" : "preview")" 
                    class="w-full border-0" 
                    style="min-height: 600px; width: 100%; max-width: 100%;" 
                    onload="initializeIframe()">
            </iframe>
        </div>
    </div>

    <!-- 底部操作栏 -->
    <div class="text-center mt-8 space-x-4">
        <button onclick="window.history.back()" class="btn btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i>返回列表
        </button>
        
        @if (ViewBag.IsEditMode == true)
        {
            <button type="button" onclick="saveEngagementLetter()" class="btn btn-primary">
                <i class="fas fa-save mr-2"></i>保存修改
            </button>
        }
        else
        {
            <button onclick="window.print()" class="btn btn-primary">
                <i class="fas fa-print mr-2"></i>导出
            </button>
        }
    </div>
</div>

<style>
    @@media print {
        .fixed, .text-center {
            display: none !important;
        }
        
        body {
            background: white !important;
        }
        
        .bg-white {
            box-shadow: none !important;
            border: none !important;
        }
        
        .shadow-md {
            box-shadow: none !important;
        }
        
        .bg-gray-50 {
            background: #f9fafb !important;
        }
        
        .border-b {
            border-bottom: 1px solid #e5e7eb !important;
        }
    }
</style>

<script>
    // 初始化iframe
    function initializeIframe() {
        var iframe = document.getElementById('engLetterContentFrame');
        if (iframe && iframe.contentWindow) {
            // 设置iframe高度和宽度
            try {
                iframe.style.height = iframe.contentWindow.document.body.scrollHeight + 'px';
                
                // 设置宽度为容器宽度
                var container = iframe.parentElement;
                if (container) {
                    iframe.style.width = container.clientWidth + 'px';
                }
            } catch (e) {
                console.log('无法自动调整iframe尺寸');
            }
        }
    }

    // 响应式调整iframe尺寸
    function adjustIframeResponsive() {
        var iframe = document.getElementById('engLetterContentFrame');
        if (iframe) {
            try {
                var container = iframe.parentElement;
                if (container) {
                    // 确保iframe宽度与容器一致
                    iframe.style.width = container.clientWidth + 'px';
                    
                    // 通知iframe内部重新计算布局
                    if (iframe.contentWindow) {
                        iframe.contentWindow.postMessage({ type: 'resize' }, '*');
                    }
                }
            } catch (e) {
                console.log('响应式调整失败');
            }
        }
    }

    // 监听窗口大小变化
    window.addEventListener('resize', function() {
        setTimeout(adjustIframeResponsive, 100);
    });

    // 监听iframe内部的消息
    window.addEventListener('message', function(e) {
        if (e.data.type === 'resizeHeight' && e.data.height) {
            var iframe = document.getElementById('engLetterContentFrame');
            if (iframe) {
                iframe.style.height = e.data.height + 'px';
            }
        } else if (e.data.type === 'optionChanged') {
            // 用户修改了选项，检查条件响应
            checkConditionalResponses();
        }
    });

    // 检查条件响应
    async function checkConditionalResponses() {
        const questionnaireId = '@Model.QuestionnaireId';
        if (!questionnaireId) return;
        
        try {
            // 获取当前问卷的所有条件响应
            const response = await fetch(`/ConditionalResponses/GetConditionalResponses?questionnaireId=${questionnaireId}`);
            const conditionalResponses = await response.json();
            console.log('获取到的条件响应:', conditionalResponses);
            if (!conditionalResponses || conditionalResponses.length === 0) return;
            
            // 获取iframe中的当前答案
            const iframe = document.getElementById('engLetterContentFrame');
            if (!iframe || !iframe.contentDocument) return;
            
            const currentAnswers = collectCurrentAnswers(iframe.contentDocument);
            
            // 检查每个条件响应
            for (const conditionResponse of conditionalResponses) {
                const conditionResponseConditions = conditionResponse.Conditions || conditionResponse.conditions;
                if (checkConditions(conditionResponseConditions, currentAnswers)) {
                    // 满足条件，应用响应
                    applyConditionalResponse(iframe.contentDocument, conditionResponse);
                } else {
                    // 不满足条件，确保问题是启用的
                    enableQuestion(iframe.contentDocument, conditionResponse.questionId);
                }
            }
        } catch (error) {
            console.error('检查条件响应失败:', error);
        }
    }
    
    // 收集当前答案
    function collectCurrentAnswers(document) {
        const answers = {};
        
        // 收集单选答案
        const radioInputs = document.querySelectorAll('input[type="radio"]:checked');
        radioInputs.forEach(input => {
            const questionId = input.name.replace('question_', '');
            answers[questionId] = [input.value];
        });
        
        // 收集多选答案
        const questionNames = new Set();
        const checkboxInputs = document.querySelectorAll('input[type="checkbox"]');
        checkboxInputs.forEach(input => {
            const questionId = input.name.replace('question_', '');
            questionNames.add(questionId);
        });
        
        questionNames.forEach(questionId => {
            if (!answers[questionId]) {
                const checkedBoxes = document.querySelectorAll(`input[name="question_${questionId}"][type="checkbox"]:checked`);
                answers[questionId] = Array.from(checkedBoxes).map(box => box.value);
            }
        });
        
        // 收集文本答案
        const textareas = document.querySelectorAll('textarea');
        textareas.forEach(textarea => {
            const questionId = textarea.name.replace('question_', '');
            if (textarea.value.trim()) {
                answers[questionId] = [textarea.value.trim()];
            }
        });
        
        return answers;
    }
    
    // 检查条件是否满足
    function checkConditions(conditions, currentAnswers) {
        if (!conditions || conditions.length === 0) return false;
        
        // 处理第一个条件
        let result = checkSingleCondition(conditions[0], currentAnswers);
        
        // 处理剩余条件
        for (let i = 1; i < conditions.length; i++) {
            const conditionMet = checkSingleCondition(conditions[i], currentAnswers);
            
            // 根据逻辑运算符组合结果
            if (conditions[i].LogicOperator === 'AND') {
                result = result && conditionMet;
            } else if (conditions[i].LogicOperator === 'OR') {
                result = result || conditionMet;
            }
        }
        
        return result;
    }
    
    // 检查单个条件
    function checkSingleCondition(condition, currentAnswers) {
        const { questionId, conditionType, textResponse } = condition;
        
        // 如果当前问题没有答案，条件不满足
        if (!currentAnswers[questionId] || currentAnswers[questionId].length === 0) {
            return false;
        }
        
        try {
            // 解析条件答案
            const conditionAnswers = JSON.parse(textResponse);
            
            // 根据条件类型检查
            switch (conditionType) {
                case 'Equals':
                    return conditionAnswers.some(answer => 
                        currentAnswers[questionId].includes(answer)
                    );
                case 'Contains':
                    return currentAnswers[questionId].some(answer => 
                        conditionAnswers.some(conditionAnswer => 
                            answer.includes(conditionAnswer)
                        )
                    );
                case 'NotEquals':
                    return !conditionAnswers.some(answer => 
                        currentAnswers[questionId].includes(answer)
                    );
                default:
                    return false;
            }
        } catch (error) {
            console.error('解析条件答案失败:', error);
            return false;
        }
    }
    
    // 应用条件响应
    function applyConditionalResponse(document, conditionResponse) {
        const { questionId, response } = conditionResponse;
        
        try {
            const responseAnswers = JSON.parse(response);
            
            // 查找对应问题的输入元素
            const questionInputs = document.querySelectorAll(`input[name="question_${questionId}"], textarea[name="question_${questionId}"]`);
            
            if (questionInputs.length === 0) return;
            
            const inputType = questionInputs[0].type;
            
            // 根据输入类型设置答案
            if (inputType === 'radio') {
                // 单选按钮
                questionInputs.forEach(input => {
                    input.checked = responseAnswers.includes(input.value);
                    input.disabled = true;
                });
            } else if (inputType === 'checkbox') {
                // 复选框
                questionInputs.forEach(input => {
                    input.checked = responseAnswers.includes(input.value);
                    input.disabled = true;
                });
            } else if (questionInputs[0].tagName === 'TEXTAREA') {
                // 文本区域
                questionInputs[0].value = responseAnswers[0] || '';
                questionInputs[0].disabled = true;
            }
        } catch (error) {
            console.error('应用条件响应失败:', error);
        }
    }
    
    // 启用问题
    function enableQuestion(document, questionId) {
        const questionInputs = document.querySelectorAll(`input[name="question_${questionId}"], textarea[name="question_${questionId}"]`);
        questionInputs.forEach(input => {
            input.disabled = false;
        });
    }

    // 保存Engagement Letter
    function saveEngagementLetter() {
        var title = document.getElementById('engLetterTitle')?.value || '@Model.Title';
        var iframe = document.getElementById('engLetterContentFrame');
        
        if (iframe && iframe.contentWindow) {
            try {
                // 从iframe获取表单数据
                var formData = new FormData();
                formData.append('Title', title);
                
                // 获取iframe中的表单数据
                var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                var inputs = iframeDoc.querySelectorAll('input[type="radio"]:checked, input[type="checkbox"]:checked, textarea, input[type="text"]');
                
                inputs.forEach(function(input) {
                    if (input.type === 'checkbox') {
                        if (input.checked) {
                            formData.append(input.name, input.value);
                        }
                    } else if (input.type === 'radio') {
                        if (input.checked) {
                            formData.append(input.name, input.value);
                        }
                    } else {
                        formData.append(input.name, input.value);
                    }
                });

                // 添加防伪令牌
                var token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                if (token) {
                    formData.append('__RequestVerificationToken', token);
                }

                // 发送保存请求
                fetch('/EngLetters/Edit/@Model.Id', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('保存成功！');
                        window.location.href = '/EngLetters';
                    } else {
                        alert('保存失败：' + (data.message || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('保存失败，请重试');
                });
            } catch (e) {
                console.error('获取iframe数据失败:', e);
                alert('保存失败，请刷新页面重试');
            }
        }
    }

    // 监听标题变化（编辑模式）
    document.addEventListener('DOMContentLoaded', function() {
        var titleInput = document.getElementById('engLetterTitle');
        if (titleInput) {
            titleInput.addEventListener('input', function() {
                document.title = '编辑: ' + this.value;
            });
        }
        
        // 在编辑模式下，页面加载完成后检查条件响应
        if ('@ViewBag.IsEditMode' === 'True') {
            setTimeout(function() {
                checkConditionalResponses();
            }, 1000); // 延迟执行，确保iframe已加载完成
        }
    });
</script>