@model EngagementLetter.Models.EngLetter

@{ ViewData["Title"] = "创建 Engagement Letter"; }

<div class="container mx-auto px-4 py-8">
    <!-- 返回按钮 -->
    <div class="fixed top-4 right-4 z-10">
        <button onclick="window.history.back()" class="btn btn-primary">
            <i class="fas fa-arrow-left mr-2"></i>返回列表
        </button>
    </div>

    <!-- 页面标题 -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800">@ViewData["Title"]</h1>
    </div>
    
    <!-- 防伪令牌 -->
    @Html.AntiForgeryToken()

    <!-- Engagement Letter 基本信息卡片 -->
    <div class="bg-white rounded-lg shadow-md mb-8">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-800">
                <i class="fas fa-file-alt mr-2 text-blue-600"></i>基本信息
            </h2>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">标题 *</label>
                        <input type="text" id="engLetterTitle" class="form-control text-lg font-semibold text-gray-900" placeholder="请输入标题" required />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">关联问卷</label>
                        <p class="text-gray-600" id="questionnaireName">
                            <i class="fas fa-clipboard-list mr-1"></i>
                            @if (ViewBag.Questionnaire != null)
                            {
                                <span>@ViewBag.Questionnaire.Title</span>
                            }
                            else
                            {
                                <span>正在加载问卷...</span>
                            }
                        </p>
                        <input type="hidden" id="questionnaireId" value="@ViewBag.Questionnaire?.Id" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 详细内容 - 使用iframe加载RenderContent -->
    <div class="bg-white rounded-lg shadow-md">
        <div class="p-6">
            <div id="questionnaireContent" class="space-y-6">
                <!-- iframe将在这里加载问卷内容 -->
                <div class="text-center text-gray-500 py-12">
                    <i class="fas fa-clipboard-list text-6xl mb-4 opacity-50"></i>
                    <h3 class="text-xl font-semibold mb-2">正在加载问卷内容...</h3>
                    <p class="text-gray-400">请稍候，正在加载已发布的问卷</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部操作栏 -->
    <div class="text-center mt-8 space-x-4">
        <button onclick="window.history.back()" class="btn btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i>取消
        </button>
        <button type="button" onclick="createEngagementLetter()" class="btn btn-primary" id="createBtn">
            <i class="fas fa-save mr-2"></i>创建
        </button>
    </div>
</div>

<style>
    @@media print {
        .fixed, .text-center {
            display: none !important;
        }
        
        body {
            background: white !important;
        }
        
        .bg-white {
            box-shadow: none !important;
            border: none !important;
        }
        
        .shadow-md {
            box-shadow: none !important;
        }
        
        .bg-gray-50 {
            background: #f9fafb !important;
        }
        
        .border-b {
            border-bottom: 1px solid #e5e7eb !important;
        }
    }
    
    .questionnaire-iframe {
        width: 100%;
        min-height: 400px;
        border: none;
        border-radius: 0.5rem;
    }
</style>

<script>
    // 页面加载时自动加载已发布的问卷
    document.addEventListener('DOMContentLoaded', function() {
        loadPublishedQuestionnaire();
    });

    // 加载已发布的问卷
    async function loadPublishedQuestionnaire() {
        try {
            const response = await fetch('/Questionnaires/GetPublishedQuestionnaires');
            const questionnaires = await response.json();
            
            if (questionnaires && questionnaires.length > 0) {
                // 获取第一个已发布的问卷
                const questionnaire = questionnaires[0];
                document.getElementById('questionnaireId').value = questionnaire.id;
                document.getElementById('questionnaireName').innerHTML = `
                    <i class="fas fa-clipboard-list mr-1"></i>
                    <span>${questionnaire.title}</span>
                `;
                
                // 加载问卷内容 - 使用iframe
                loadQuestionnaireContent(questionnaire.id);
            } else {
                document.getElementById('questionnaireContent').innerHTML = `
                    <div class="text-center text-red-500 py-12">
                        <i class="fas fa-exclamation-triangle text-6xl mb-4 opacity-50"></i>
                        <h3 class="text-xl font-semibold mb-2">没有可用的问卷</h3>
                        <p class="text-gray-400">当前没有已发布的问卷，请联系管理员</p>
                    </div>
                `;
                document.getElementById('createBtn').disabled = true;
            }
        } catch (error) {
            console.error('加载问卷失败:', error);
            document.getElementById('questionnaireContent').innerHTML = `
                <div class="text-center text-red-500 py-12">
                    <i class="fas fa-exclamation-triangle text-6xl mb-4 opacity-50"></i>
                    <h3 class="text-xl font-semibold mb-2">加载失败</h3>
                    <p class="text-gray-400">无法加载问卷内容，请刷新页面重试</p>
                </div>
            `;
            document.getElementById('createBtn').disabled = true;
        }
    }

    // 加载问卷内容 - 使用iframe加载RenderCreateContent
    function loadQuestionnaireContent(questionnaireId) {
        const contentDiv = document.getElementById('questionnaireContent');
        
        // 创建iframe加载RenderCreateContent
        const iframe = document.createElement('iframe');
        iframe.src = `/EngLetters/RenderCreateContent?questionnaireId=${questionnaireId}`;
        iframe.className = 'questionnaire-iframe';
        iframe.onload = function() {
            // 调整iframe高度以适应内容
            setTimeout(() => {
                try {
                    const iframeHeight = iframe.contentDocument?.body?.scrollHeight || 400;
                    iframe.style.height = iframeHeight + 'px';
                } catch (e) {
                    // 处理跨域问题
                    console.log('无法访问iframe内容，使用默认高度');
                    iframe.style.height = '600px';
                }
            }, 100);
        };
        
        contentDiv.innerHTML = '';
        contentDiv.appendChild(iframe);
    }

    // 创建Engagement Letter
    async function createEngagementLetter() {
        const title = document.getElementById('engLetterTitle').value.trim();
        const questionnaireId = document.getElementById('questionnaireId').value;
        
        if (!title) {
            alert('请输入标题');
            return;
        }
        
        if (!questionnaireId) {
            alert('系统未加载到问卷，请刷新页面重试');
            return;
        }

        try {
            const formData = new FormData();
            formData.append('Title', title);
            formData.append('QuestionnaireId', questionnaireId);
            
            // 从iframe中收集答案
            const iframe = document.querySelector('.questionnaire-iframe');
            if (iframe && iframe.contentDocument) {
                const inputs = iframe.contentDocument.querySelectorAll('input[type="radio"]:checked, input[type="checkbox"]:checked, textarea');
                inputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        formData.append(input.name, input.value);
                    } else {
                        formData.append(input.name, input.value);
                    }
                });
            }

            // 添加防伪令牌
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            if (token) {
                formData.append('__RequestVerificationToken', token);
            }

            const response = await fetch('/EngLetters/Create', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('创建成功！');
                window.location.href = '/EngLetters';
            } else {
                alert('创建失败：' + (result.message || '未知错误'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('创建失败，请重试');
        }
    }

    // 监听标题变化
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('engLetterTitle').addEventListener('input', function() {
            document.title = '创建: ' + this.value;
        });
        // 添加消息事件监听器，用于接收iframe中的选择变化和高度调整
        window.addEventListener('message', function(event) {
            // 验证消息来源，确保安全性
            if (event.origin !== window.location.origin && event.origin !== '*') return;
            
            if (event.data && event.data.type === 'optionChanged') {
                // 用户修改了选项，检查条件响应
                checkConditionalResponses();
            } else if (event.data && event.data.type === 'resizeHeight') {
                // 调整iframe高度
                const iframe = document.querySelector('.questionnaire-iframe');
                if (iframe) {
                    iframe.style.height = event.data.height + 'px';
                }
            }
        });
    });

    // 检查条件响应
    async function checkConditionalResponses() {
        const questionnaireId = document.getElementById('questionnaireId').value;
        if (!questionnaireId) return;
        
        try {
            // 获取当前问卷的所有条件响应
            const response = await fetch(`/ConditionalResponses/GetConditionalResponses?questionnaireId=${questionnaireId}`);
            const conditionalResponses = await response.json();
            console.log('获取到的条件响应:', conditionalResponses);
            if (!conditionalResponses || conditionalResponses.length === 0) return;
            
            // 获取iframe中的当前答案
            const iframe = document.querySelector('.questionnaire-iframe');
            if (!iframe || !iframe.contentDocument) return;
            
            const currentAnswers = collectCurrentAnswers(iframe.contentDocument);
            //console.log('获取到的当前答案:', currentAnswers);
            
            // 检查每个条件响应
            for (const conditionResponse of conditionalResponses) {
                const conditionResponseConditions = conditionResponse.Conditions || conditionResponse.conditions;
                if (checkConditions(conditionResponseConditions, currentAnswers)) {
                    // 满足条件，应用响应
                    applyConditionalResponse(iframe.contentDocument, conditionResponse);
                } else {
                    // 不满足条件，确保问题是启用的
                    enableQuestion(iframe.contentDocument, conditionResponse.questionId);
                }
            }
        } catch (error) {
            console.error('检查条件响应失败:', error);
        }
    }
    
    // 收集当前答案
    function collectCurrentAnswers(document) {
        const answers = {};
        
        // 收集单选答案
        const radioInputs = document.querySelectorAll('input[type="radio"]:checked');
        radioInputs.forEach(input => {
            const questionId = input.name.replace('question_', '');
            answers[questionId] = [input.value];
        });
        
        // 收集多选答案
        const questionNames = new Set();
        const checkboxInputs = document.querySelectorAll('input[type="checkbox"]');
        checkboxInputs.forEach(input => {
            const questionId = input.name.replace('question_', '');
            questionNames.add(questionId);
        });
        
        questionNames.forEach(questionId => {
            if (!answers[questionId]) {
                const checkedBoxes = document.querySelectorAll(`input[name="question_${questionId}"][type="checkbox"]:checked`);
                answers[questionId] = Array.from(checkedBoxes).map(box => box.value);
            }
        });
        
        // 收集文本答案
        const textareas = document.querySelectorAll('textarea');
        textareas.forEach(textarea => {
            const questionId = textarea.name.replace('question_', '');
            if (textarea.value.trim()) {
                answers[questionId] = [textarea.value.trim()];
            }
        });
        
        return answers;
    }
    
    // 检查条件是否满足
    function checkConditions(conditions, currentAnswers) {
        if (!conditions || conditions.length === 0) return false;
        
        // 处理第一个条件
        let result = checkSingleCondition(conditions[0], currentAnswers);
        
        // 处理剩余条件
        for (let i = 1; i < conditions.length; i++) {
            const conditionMet = checkSingleCondition(conditions[i], currentAnswers);
            
            // 根据逻辑运算符组合结果
            if (conditions[i].LogicOperator === 'AND') {
                result = result && conditionMet;
            } else if (conditions[i].LogicOperator === 'OR') {
                result = result || conditionMet;
            }
        }
        
        return result;
    }
    
    // 检查单个条件
    function checkSingleCondition(condition, currentAnswers) {
        const { questionId, conditionType, textResponse } = condition;
        
        // 如果当前问题没有答案，条件不满足
        console.log('当前问题ID:', questionId);
        console.log('当前问题答案:', currentAnswers[questionId]);
        if (!currentAnswers[questionId] || currentAnswers[questionId].length === 0) {
            return false;
        }
        
        try {
            // 解析条件答案
            const conditionAnswers = JSON.parse(textResponse);
            
            // 根据条件类型检查
            switch (conditionType) {
                case 'Equals':
                    return conditionAnswers.some(answer => 
                        currentAnswers[questionId].includes(answer)
                    );
                case 'Contains':
                    return currentAnswers[questionId].some(answer => 
                        conditionAnswers.some(conditionAnswer => 
                            answer.includes(conditionAnswer)
                        )
                    );
                case 'NotEquals':
                    return !conditionAnswers.some(answer => 
                        currentAnswers[questionId].includes(answer)
                    );
                default:
                    return false;
            }
        } catch (error) {
            console.error('解析条件答案失败:', error);
            return false;
        }
    }
    
    // 应用条件响应
    function applyConditionalResponse(document, conditionResponse) {
        const { questionId, response } = conditionResponse;
        
        try {
            const responseAnswers = JSON.parse(response);
            
            // 查找对应问题的输入元素
            const questionInputs = document.querySelectorAll(`input[name="question_${questionId}"], textarea[name="question_${questionId}"]`);
            
            if (questionInputs.length === 0) return;
            
            const inputType = questionInputs[0].type;
            
            // 根据输入类型设置答案
            if (inputType === 'radio') {
                // 单选按钮
                questionInputs.forEach(input => {
                    input.checked = responseAnswers.includes(input.value);
                    input.disabled = true;
                });
            } else if (inputType === 'checkbox') {
                // 复选框
                questionInputs.forEach(input => {
                    input.checked = responseAnswers.includes(input.value);
                    input.disabled = true;
                });
            } else if (questionInputs[0].tagName === 'TEXTAREA') {
                // 文本区域
                questionInputs[0].value = responseAnswers[0] || '';
                questionInputs[0].disabled = true;
            }
        } catch (error) {
            console.error('应用条件响应失败:', error);
        }
    }
    
    // 启用问题
    function enableQuestion(document, questionId) {
        const questionInputs = document.querySelectorAll(`input[name="question_${questionId}"], textarea[name="question_${questionId}"]`);
        questionInputs.forEach(input => {
            input.disabled = false;
        });
    }
</script>